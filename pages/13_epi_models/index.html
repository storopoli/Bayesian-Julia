<!doctype html> <html lang=en > <meta charset=UTF-8 > <meta name=viewport  content="width=device-width, initial-scale=1"> <link rel=stylesheet  href="/Bayesian-Julia/libs/katex/katex.min.css"> <link rel=stylesheet  href="/Bayesian-Julia/libs/highlight/github.min.css"> <link rel=stylesheet  href="/Bayesian-Julia/css/jtd.css"> <link rel=icon  href="/Bayesian-Julia/assets/favicon.ico"> <title>Bonus: Epidemiological Models using ODE Solvers in Turing</title> <div class=page-wrap > <div class=side-bar > <div class=header > <a href="/Bayesian-Julia/" class=title > Bayesian Stats </a> </div> <label for=show-menu  class=show-menu >MENU</label> <input type=checkbox  id=show-menu  role=button > <div class=menu  id=side-menu > <ul class=menu-list > <li class="menu-list-item "><a href="/Bayesian-Julia/" class="menu-list-link ">Home</a> <li class="menu-list-item "><a href="/Bayesian-Julia/pages/01_why_Julia/" class="menu-list-link ">1. Why Julia?</a> <li class="menu-list-item "><a href="/Bayesian-Julia/pages/02_bayes_stats/" class="menu-list-link ">2. What is Bayesian Statistics?</a> <li class="menu-list-item "><a href="/Bayesian-Julia/pages/03_prob_dist/" class="menu-list-link ">3. Common Probability Distributions</a> <li class="menu-list-item "><a href="/Bayesian-Julia/pages/04_Turing/" class="menu-list-link ">4. How to use Turing</a> <li class="menu-list-item "><a href="/Bayesian-Julia/pages/05_MCMC/" class="menu-list-link ">5. Markov Chain Monte Carlo (MCMC)</a> <li class="menu-list-item "><a href="/Bayesian-Julia/pages/06_linear_reg/" class="menu-list-link ">6. Bayesian Linear Regression</a> <li class="menu-list-item "><a href="/Bayesian-Julia/pages/07_logistic_reg/" class="menu-list-link ">7. Bayesian Logistic Regression</a> <li class="menu-list-item "><a href="/Bayesian-Julia/pages/08_ordinal_reg/" class="menu-list-link ">8. Bayesian Ordinal Regression</a> <li class="menu-list-item "><a href="/Bayesian-Julia/pages/09_count_reg/" class="menu-list-link ">9. Bayesian Regression with Count Data</a> <li class="menu-list-item "><a href="/Bayesian-Julia/pages/10_robust_reg/" class="menu-list-link ">10. Robust Bayesian Regression</a> <li class="menu-list-item "><a href="/Bayesian-Julia/pages/11_multilevel_models/" class="menu-list-link ">11. Multilevel Models</a> <li class="menu-list-item "><a href="/Bayesian-Julia/pages/12_Turing_tricks/" class="menu-list-link ">12. Computational Tricks with Turing</a> <li class="menu-list-item active"><a href="/Bayesian-Julia/pages/13_epi_models/" class="menu-list-link active">13. Bayesian Epidemiological Models</a> </ul> </div> <div class=footer > <a href="https://www.julialang.org"><img style="height:50px;padding-left:10px;margin-bottom:15px;" src="https://julialang.org/assets/infra/logo.svg" alt="Julia Logo"></a> </div> </div> <div class=main-content-wrap > <div class=main-content > <div class=main-header > <a id=github  href="https://github.com/storopoli/Bayesian-Julia">Code on GitHub</a> </div> <div class=franklin-content ><div class=franklin-toc ><ol><li><a href="#how_to_code_an_ode_in_julia">How to code an ODE in Julia?</a><li><a href="#how_to_use_a_ode_solver_in_a_turing_model">How to use a ODE solver in a Turing Model</a><li><a href="#references">References</a></ol></div> <h1 id=bonus_epidemiological_models_using_ode_solvers_in_turing ><a href="#bonus_epidemiological_models_using_ode_solvers_in_turing" class=header-anchor >Bonus: Epidemiological Models using ODE Solvers in Turing</a></h1> <p>Ok, now this is something that really makes me very excited with Julia&#39;s ecosystem. If you want to use an Ordinary Differential Equation solver in your Turing model, you don&#39;t need to code it from scratch. You&#39;ve just <strong>borrow a pre-made one</strong> from <a href="https://diffeq.sciml.ai/dev/"><code>DifferentialEquations.jl</code></a>. This is what makes Julia so great. We can use functions and types defined in other packages into another package and it will probably work either straight out of the bat or without much effort&#33;</p> <p>For this tutorial I&#39;ll be using Brazil&#39;s COVID data from the <a href="https://brasil.io/covid19/">Media Consortium</a>. For reproducibility, we&#39;ll restrict the data to the year of 2020:</p> <pre><code class="julia hljs"><span class=hljs-keyword >using</span> Downloads
<span class=hljs-keyword >using</span> DataFrames
<span class=hljs-keyword >using</span> CSV
<span class=hljs-keyword >using</span> Chain
<span class=hljs-keyword >using</span> Dates

url = <span class=hljs-string >&quot;https://data.brasil.io/dataset/covid19/caso_full.csv.gz&quot;</span>
file = Downloads.download(url)
df = DataFrame(CSV.File(file))
br = <span class=hljs-meta >@chain</span> df <span class=hljs-keyword >begin</span>
    filter(
        [:date, :city] =&gt;
            (date, city) -&gt;
                date &lt; Dates.Date(<span class=hljs-string >&quot;2021-01-01&quot;</span>) &amp;&amp;
                    date &gt; Dates.Date(<span class=hljs-string >&quot;2020-04-01&quot;</span>) &amp;&amp;
                    ismissing(city),
        _,
    )
    groupby(:date)
    combine(
        [
            :estimated_population_2019,
            :last_available_confirmed_per_100k_inhabitants,
            :last_available_deaths,
            :new_confirmed,
            :new_deaths,
        ] .=&gt;
            sum .=&gt; [
                :estimated_population_2019,
                :last_available_confirmed_per_100k_inhabitants,
                :last_available_deaths,
                :new_confirmed,
                :new_deaths,
            ],
    )
<span class=hljs-keyword >end</span>;</code></pre> <p>Let&#39;s take a look in the first observations</p> <pre><code class="julia hljs">first(br, <span class=hljs-number >5</span>)</code></pre><pre><code class="plaintext hljs">5×6 DataFrame
 Row │ date        estimated_population_2019  last_available_confirmed_per_100k_inhabitants  last_available_deaths  new_confirmed  new_deaths
     │ Date        Int64                      Float64                                        Int64                  Int64          Int64
─────┼────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
   1 │ 2020-04-02                  210147125                                        79.6116                    305           1167          61
   2 │ 2020-04-03                  210147125                                        90.9596                    365           1114          60
   3 │ 2020-04-04                  210147125                                       103.622                     445           1169          80
   4 │ 2020-04-05                  210147125                                       115.594                     496           1040          51
   5 │ 2020-04-06                  210147125                                       125.766                     569            840          73</code></pre> <p>Also the bottom rows</p> <pre><code class="julia hljs">last(br, <span class=hljs-number >5</span>)</code></pre><pre><code class="plaintext hljs">5×6 DataFrame
 Row │ date        estimated_population_2019  last_available_confirmed_per_100k_inhabitants  last_available_deaths  new_confirmed  new_deaths
     │ Date        Int64                      Float64                                        Int64                  Int64          Int64
─────┼────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
   1 │ 2020-12-27                  210147125                                      1.22953e5                 191250          17614         337
   2 │ 2020-12-28                  210147125                                      1.23554e5                 191788          27437         538
   3 │ 2020-12-29                  210147125                                      1.24291e5                 192839          56371        1051
   4 │ 2020-12-30                  210147125                                      1.25047e5                 194056          55600        1217
   5 │ 2020-12-31                  210147125                                      1.25724e5                 195072          54469        1016</code></pre> <p>Here is a plot of the data:</p> <pre><code class="julia hljs"><span class=hljs-keyword >using</span> AlgebraOfGraphics
<span class=hljs-keyword >using</span> CairoMakie
f = Figure()
plt = data(br) * mapping(:date =&gt; <span class=hljs-string >L&quot;t&quot;</span>, :new_confirmed =&gt; <span class=hljs-string >&quot;infected daily&quot;</span>) * visual(Lines)
draw!(f[<span class=hljs-number >1</span>, <span class=hljs-number >1</span>], plt)</code></pre> <p><img src="/Bayesian-Julia/assets/pages/13_epi_models/code/output/infected.svg" alt=""> <div class=text-center ><em>Infected in Brazil during COVID in 2020</em></div> <br/></p> <p>The Susceptible-Infected-Recovered &#40;SIR&#41; &#40;Grinsztajn, Semenova, Margossian &amp; Riou, 2021&#41; model splits the population in three time-dependent compartments: the susceptible, the infected &#40;and infectious&#41;, and the recovered &#40;and not infectious&#41; compartments. When a susceptible individual comes into contact with an infectious individual, the former can become infected for some time, and then recover and become immune. The dynamics can be summarized in a system ODEs:</p> <p><img src="/Bayesian-Julia/pages/images/SIR.png" alt="SIR Model" /></p> <p><div class=text-center ><em>Susceptible-Infected-Recovered &#40;SIR&#41; model</em></div> <br/></p> <span class=katex-display ><span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML" display=block ><semantics><mtable rowspacing=0.2500em  columnalign="right left" columnspacing=0em ><mtr><mtd><mstyle scriptlevel=0  displaystyle=true ><mfrac><mrow><mi>d</mi><mi>S</mi></mrow><mrow><mi>d</mi><mi>t</mi></mrow></mfrac></mstyle></mtd><mtd><mstyle scriptlevel=0  displaystyle=true ><mrow><mrow></mrow><mo>=</mo><mo>−</mo><mi>β</mi><mi>S</mi><mfrac><mi>I</mi><mi>N</mi></mfrac></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel=0  displaystyle=true ><mfrac><mrow><mi>d</mi><mi>I</mi></mrow><mrow><mi>d</mi><mi>t</mi></mrow></mfrac></mstyle></mtd><mtd><mstyle scriptlevel=0  displaystyle=true ><mrow><mrow></mrow><mo>=</mo><mi>β</mi><mi>S</mi><mfrac><mi>I</mi><mi>N</mi></mfrac><mo>−</mo><mi>γ</mi><mi>I</mi></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel=0  displaystyle=true ><mfrac><mrow><mi>d</mi><mi>R</mi></mrow><mrow><mi>d</mi><mi>t</mi></mrow></mfrac></mstyle></mtd><mtd><mstyle scriptlevel=0  displaystyle=true ><mrow><mrow></mrow><mo>=</mo><mi>γ</mi><mi>I</mi></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex"> \begin{aligned} \frac{dS}{dt} &amp;= -\beta S \frac{I}{N}\\ \frac{dI}{dt} &amp;= \beta S \frac{I}{N} - \gamma I \\ \frac{dR}{dt} &amp;= \gamma I \end{aligned} </annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:7.0723199999999995em;vertical-align:-3.28616em;"></span><span class=mord ><span class=mtable ><span class=col-align-r ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:3.7861599999999997em;"><span style="top:-5.78616em;"><span class=pstrut  style="height:3.3714399999999998em;"></span><span class=mord ><span class=mord ><span class="mopen nulldelimiter"></span><span class=mfrac ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:1.37144em;"><span style="top:-2.314em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class="mord mathnormal">d</span><span class="mord mathnormal">t</span></span></span><span style="top:-3.23em;"><span class=pstrut  style="height:3em;"></span><span class=frac-line  style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class="mord mathnormal">d</span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span><span style="top:-3.428719999999999em;"><span class=pstrut  style="height:3.3714399999999998em;"></span><span class=mord ><span class=mord ><span class="mopen nulldelimiter"></span><span class=mfrac ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:1.37144em;"><span style="top:-2.314em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class="mord mathnormal">d</span><span class="mord mathnormal">t</span></span></span><span style="top:-3.23em;"><span class=pstrut  style="height:3em;"></span><span class=frac-line  style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class="mord mathnormal">d</span><span class="mord mathnormal" style="margin-right:0.07847em;">I</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span><span style="top:-1.0712799999999998em;"><span class=pstrut  style="height:3.3714399999999998em;"></span><span class=mord ><span class=mord ><span class="mopen nulldelimiter"></span><span class=mfrac ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:1.37144em;"><span style="top:-2.314em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class="mord mathnormal">d</span><span class="mord mathnormal">t</span></span></span><span style="top:-3.23em;"><span class=pstrut  style="height:3em;"></span><span class=frac-line  style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class="mord mathnormal">d</span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:3.28616em;"><span></span></span></span></span></span><span class=col-align-l ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:3.7861599999999997em;"><span style="top:-5.78616em;"><span class=pstrut  style="height:3.3714399999999998em;"></span><span class=mord ><span class=mord ></span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mord >−</span><span class="mord mathnormal" style="margin-right:0.05764em;">βS</span><span class=mord ><span class="mopen nulldelimiter"></span><span class=mfrac ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:1.36033em;"><span style="top:-2.314em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span><span style="top:-3.23em;"><span class=pstrut  style="height:3em;"></span><span class=frac-line  style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.07847em;">I</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span><span style="top:-3.428719999999999em;"><span class=pstrut  style="height:3.3714399999999998em;"></span><span class=mord ><span class=mord ></span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">βS</span><span class=mord ><span class="mopen nulldelimiter"></span><span class=mfrac ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:1.36033em;"><span style="top:-2.314em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span><span style="top:-3.23em;"><span class=pstrut  style="height:3em;"></span><span class=frac-line  style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class=pstrut  style="height:3em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.07847em;">I</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class=mbin >−</span><span class=mspace  style="margin-right:0.2222222222222222em;"></span><span class="mord mathnormal" style="margin-right:0.05556em;">γ</span><span class="mord mathnormal" style="margin-right:0.07847em;">I</span></span></span><span style="top:-1.0712799999999998em;"><span class=pstrut  style="height:3.3714399999999998em;"></span><span class=mord ><span class=mord ></span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class="mord mathnormal" style="margin-right:0.05556em;">γ</span><span class="mord mathnormal" style="margin-right:0.07847em;">I</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:3.28616em;"><span></span></span></span></span></span></span></span></span></span></span></span> <p>where:</p> <ul> <li><p><span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mo stretchy=false >(</mo><mi>t</mi><mo stretchy=false >)</mo></mrow><annotation encoding="application/x-tex">S(t)</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class=mopen >(</span><span class="mord mathnormal">t</span><span class=mclose >)</span></span></span></span> – the number of people susceptible to becoming infected &#40;no immunity&#41;</p> <li><p><span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>I</mi><mo stretchy=false >(</mo><mi>t</mi><mo stretchy=false >)</mo></mrow><annotation encoding="application/x-tex">I(t)</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.07847em;">I</span><span class=mopen >(</span><span class="mord mathnormal">t</span><span class=mclose >)</span></span></span></span> – the number of people currently infected &#40;and infectious&#41;</p> <li><p><span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>R</mi><mo stretchy=false >(</mo><mi>t</mi><mo stretchy=false >)</mo></mrow><annotation encoding="application/x-tex">R(t)</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class=mopen >(</span><span class="mord mathnormal">t</span><span class=mclose >)</span></span></span></span> – the number of recovered people &#40;we assume they remain immune indefinitely&#41;</p> <li><p><span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>β</mi></mrow><annotation encoding="application/x-tex">\beta</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.05278em;">β</span></span></span></span> – the constant rate of infectious contact between people</p> <li><p><span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>γ</mi></mrow><annotation encoding="application/x-tex">\gamma</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.05556em;">γ</span></span></span></span> – constant recovery rate of infected individuals</p> </ul> <h2 id=how_to_code_an_ode_in_julia ><a href="#how_to_code_an_ode_in_julia" class=header-anchor >How to code an ODE in Julia?</a></h2> <p>It&#39;s very easy:</p> <ol> <li><p>Use <a href="https://diffeq.sciml.ai/"><code>DifferentialEquations.jl</code></a></p> <li><p>Create a ODE function</p> <li><p>Choose:</p> <ul> <li><p>Initial Conditions – <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>u</mi><mn>0</mn></msub></mrow><annotation encoding="application/x-tex">u_0</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.58056em;vertical-align:-0.15em;"></span><span class=mord ><span class="mord mathnormal">u</span><span class=msupsub ><span class="vlist-t vlist-t2"><span class=vlist-r ><span class=vlist  style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class=vlist-s >​</span></span><span class=vlist-r ><span class=vlist  style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></p> <li><p>Parameters – <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi></mrow><annotation encoding="application/x-tex">p</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">p</span></span></span></span></p> <li><p>Time Span – <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi></mrow><annotation encoding="application/x-tex">t</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.61508em;vertical-align:0em;"></span><span class="mord mathnormal">t</span></span></span></span></p> <li><p><em>Optional</em> – <a href="https://diffeq.sciml.ai/stable/solvers/ode_solve/">Solver</a> or leave blank for auto</p> </ul> </ol> <p>PS: If you like SIR models checkout <a href="https://github.com/epirecipes/sir-julia"><code>epirecipes/sir-julia</code></a></p> <p>The following function provides the derivatives of the model, which it changes in-place. State variables and parameters are unpacked from <code>u</code> and <code>p</code>; this incurs a slight performance hit, but makes the equations much easier to read.</p> <pre><code class="julia hljs"><span class=hljs-keyword >using</span> DifferentialEquations

<span class=hljs-keyword >function</span> sir_ode!(du, u, p, t)
    (S, I, R) = u
    (β, γ) = p
    N = S + I + R
    infection = β * I * S / N
    recovery = γ * I
    <span class=hljs-meta >@inbounds</span> <span class=hljs-keyword >begin</span>
        du[<span class=hljs-number >1</span>] = -infection <span class=hljs-comment ># Susceptible</span>
        du[<span class=hljs-number >2</span>] = infection - recovery <span class=hljs-comment ># Infected</span>
        du[<span class=hljs-number >3</span>] = recovery <span class=hljs-comment ># Recovered</span>
    <span class=hljs-keyword >end</span>
    <span class=hljs-keyword >return</span> <span class=hljs-literal >nothing</span>
<span class=hljs-keyword >end</span>;</code></pre> <p>This is what the infection would look with some fixed <code>β</code> and <code>γ</code> in a timespan of 100 days starting from day one with 1,167 infected &#40;Brazil in April 2020&#41;:</p> <pre><code class="julia hljs">i₀ = first(br[:, :new_confirmed])
N = maximum(br[:, :estimated_population_2019])

u = [N - i₀, i₀, <span class=hljs-number >0.0</span>]
p = [<span class=hljs-number >0.5</span>, <span class=hljs-number >0.05</span>]
prob = ODEProblem(sir_ode!, u, (<span class=hljs-number >1.0</span>, <span class=hljs-number >100.0</span>), p)
sol_ode = solve(prob)
f = Figure()
plt =
    data(stack(DataFrame(sol_ode), Not(:timestamp))) *
    mapping(
        :timestamp =&gt; <span class=hljs-string >L&quot;t&quot;</span>,
        :value =&gt; <span class=hljs-string >L&quot;N&quot;</span>;
        color=:variable =&gt; renamer([<span class=hljs-string >&quot;value1&quot;</span> =&gt; <span class=hljs-string >&quot;S&quot;</span>, <span class=hljs-string >&quot;value2&quot;</span> =&gt; <span class=hljs-string >&quot;I&quot;</span>, <span class=hljs-string >&quot;value3&quot;</span> =&gt; <span class=hljs-string >&quot;R&quot;</span>]),
    ) *
    visual(Lines; linewidth=<span class=hljs-number >3</span>)
draw!(f[<span class=hljs-number >1</span>, <span class=hljs-number >1</span>], plt; axis=(; title=<span class=hljs-string >&quot;SIR Model for 100 days, β = <span class=hljs-subst >$(p[<span class=hljs-number >1</span>])</span>, γ = <span class=hljs-subst >$(p[<span class=hljs-number >2</span>])</span>&quot;</span>))</code></pre> <p><img src="/Bayesian-Julia/assets/pages/13_epi_models/code/output/ode_solve.svg" alt=""> <div class=text-center ><em>SIR ODE Solution for Brazil&#39;s 100 days of COVID in early 2020</em></div> <br/></p> <h2 id=how_to_use_a_ode_solver_in_a_turing_model ><a href="#how_to_use_a_ode_solver_in_a_turing_model" class=header-anchor >How to use a ODE solver in a Turing Model</a></h2> <p>Please note that we are using the alternative negative binomial parameterization as specified in <a href="/Bayesian-Julia/pages/8_count_reg/">8. <strong>Bayesian Regression with Count Data</strong></a>:</p> <pre><code class="julia hljs"><span class=hljs-keyword >function</span> NegativeBinomial2(μ, ϕ)
    p = <span class=hljs-number >1</span> / (<span class=hljs-number >1</span> + μ / ϕ)
    r = ϕ

    <span class=hljs-keyword >return</span> NegativeBinomial(r, p)
<span class=hljs-keyword >end</span></code></pre><pre><code class="plaintext hljs">NegativeBinomial2 (generic function with 1 method)</code></pre>
<p>Now this is the fun part. It&#39;s easy: just stick it inside&#33;</p>
<pre><code class="julia hljs"><span class=hljs-keyword >using</span> Turing
<span class=hljs-keyword >using</span> LazyArrays
<span class=hljs-keyword >using</span> Random: seed!
seed!(<span class=hljs-number >123</span>)

<span class=hljs-meta >@model</span> <span class=hljs-keyword >function</span> bayes_sir(infected, i₀, r₀, N)
    <span class=hljs-comment >#calculate number of timepoints</span>
    l = length(infected)

    <span class=hljs-comment >#priors</span>
    β ~ TruncatedNormal(<span class=hljs-number >2</span>, <span class=hljs-number >1</span>, <span class=hljs-number >1e-4</span>, <span class=hljs-number >10</span>)     <span class=hljs-comment ># using 10 because numerical issues arose</span>
    γ ~ TruncatedNormal(<span class=hljs-number >0.4</span>, <span class=hljs-number >0.5</span>, <span class=hljs-number >1e-4</span>, <span class=hljs-number >10</span>) <span class=hljs-comment ># using 10 because numerical issues arose</span>
    ϕ⁻ ~ truncated(Exponential(<span class=hljs-number >5</span>); lower=<span class=hljs-number >0</span>, upper=<span class=hljs-number >1e5</span>)
    ϕ = <span class=hljs-number >1.0</span> / ϕ⁻

    <span class=hljs-comment >#ODE Stuff</span>
    I = i₀
    u0 = [N - I, I, r₀] <span class=hljs-comment ># S,I,R</span>
    p = [β, γ]
    tspan = (<span class=hljs-number >1.0</span>, float(l))
    prob = ODEProblem(sir_ode!, u0, tspan, p)
    sol = solve(
        prob,
        Tsit5(); <span class=hljs-comment ># similar to Dormand-Prince RK45 in Stan but 20% faster</span>
        saveat=<span class=hljs-number >1.0</span>,
    )
    solᵢ = <span class=hljs-built_in >Array</span>(sol)[<span class=hljs-number >2</span>, :] <span class=hljs-comment ># New Infected</span>
    solᵢ = max.(<span class=hljs-number >1e-4</span>, solᵢ) <span class=hljs-comment ># numerical issues arose</span>

    <span class=hljs-comment >#likelihood</span>
    <span class=hljs-keyword >return</span> infected ~ arraydist(LazyArray(@~ NegativeBinomial2.(solᵢ, ϕ)))
<span class=hljs-keyword >end</span>;</code></pre>
<p>Now run the model and inspect our parameters estimates. We will be using the default <code>NUTS&#40;&#41;</code> sampler with <code>1_000</code> samples on only one Markov chain:</p>
<pre><code class="julia hljs">infected = br[:, :new_confirmed]
r₀ = first(br[:, :new_deaths])
model_sir = bayes_sir(infected, i₀, r₀, N)
chain_sir = sample(model_sir, NUTS(), <span class=hljs-number >1_000</span>)
summarystats(chain_sir[[:β, :γ]])</code></pre><pre><code class="plaintext hljs">UndefVarError: `TruncatedNormal` not defined in `Main.FD_SANDBOX_7785036191933041162`
Suggestion: check for spelling errors or missing imports.
</code></pre>
<p>Hope you had learned some new bayesian computational skills and also took notice of the amazing potential of Julia&#39;s ecosystem of packages.</p>
<h2 id=references ><a href="#references" class=header-anchor >References</a></h2>
<p>Grinsztajn, L., Semenova, E., Margossian, C. C., &amp; Riou, J. &#40;2021&#41;. Bayesian workflow for disease transmission modeling in Stan. ArXiv:2006.02985 &#91;q-Bio, Stat&#93;. http://arxiv.org/abs/2006.02985</p>

<div class=page-foot >
  <div class=copyright >
    Last modified: October 26, 2024. Website built with <a href="https://github.com/tlienart/Franklin.jl">Franklin.jl</a> and the <a href="https://julialang.org">Julia programming language</a>.
  </div>
</div>
</div>
    </div> 
    </div> 
    </div> <!-- end of class page-wrap-->